<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BLUOM Stream Ultimate</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<style>
body {margin:0; font-family:Arial, sans-serif; background:#0b0f1a; color:white; text-align:center;}
header{background:#10182f; padding:10px;}
input, button{margin:4px; padding:8px; border-radius:6px; border:none;}
button{background:#1e90ff; color:white;}
video{width:45%; max-width:400px; margin:5px; border-radius:10px; background:black;}
#chat{max-height:150px; overflow:auto; background:#111; padding:6px; text-align:left;}
#rooms{background:#111; padding:6px; margin:6px 0; text-align:left;}
</style>
</head>
<body>

<header>
<h2>ðŸš€ BLUOM Stream Ultimate</h2>
<input id="username" placeholder="Name">
<input id="roomInput" placeholder="Room ID">
<input id="passInput" placeholder="Password">
<br>
<button id="createBtn">Create Room</button>
<button id="joinBtn">Join Room</button>
<button id="camBtn">Camera</button>
<button id="screenBtn">Screen</button>
<button id="recordBtn">Record</button>
<span>ðŸ‘€ <span id="viewers">0</span></span>
<div id="status"></div>
</header>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<div id="rooms"></div>
<div id="chat"></div>
<input id="chatInput" placeholder="Chat here...">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
 getFirestore, doc, setDoc, getDoc, updateDoc,
 collection, addDoc, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// PWA Service Worker
if ('serviceWorker' in navigator) {
 navigator.serviceWorker.register('sw.js')
 .then(()=>console.log("SW registered"))
 .catch(console.error);
}

// Firebase config
const firebaseConfig = {
 apiKey:"AIzaSyBDZmMalbyUmKiTl7CaN5a5Zn-qTIFVI0E",
 authDomain:"live-camera-online.firebaseapp.com",
 projectId:"live-camera-online",
 storageBucket:"live-camera-online.firebasestorage.app",
 messagingSenderId:"914071703053",
 appId:"1:914071703053:web:c2b59d8750ee04a58b0f44"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let pc, localStream, roomRef, recorder, chunks = [];
const lv = document.getElementById("localVideo");
const rv = document.getElementById("remoteVideo");
const chatDiv = document.getElementById("chat");
const roomsDiv = document.getElementById("rooms");
const viewers = document.getElementById("viewers");
const status = document.getElementById("status");

async function initPeer() {
 pc = new RTCPeerConnection({
   iceServers:[
     {urls:"stun:stun.l.google.com:19302"},
     {urls:"turn:openrelay.metered.ca:80", username:"openrelayproject", credential:"openrelayproject"},
     {urls:"turn:openrelay.metered.ca:443", username:"openrelayproject", credential:"openrelayproject"}
   ]
 });
 pc.ontrack = e => rv.srcObject = e.streams[0];
 pc.onicecandidate = e => {
   if(e.candidate) addDoc(collection(roomRef,"candidates"), e.candidate.toJSON());
 };
}

// Media functions
async function setCam() {
 localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
 lv.srcObject = localStream;
 localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
}

async function setScreen() {
 localStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
 lv.srcObject = localStream;
 localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
}

// Record
document.getElementById("recordBtn").onclick = () => {
 if(recorder?.state==="recording"){recorder.stop();return;}
 chunks=[];
 recorder = new MediaRecorder(rv.srcObject);
 recorder.ondataavailable = e => chunks.push(e.data);
 recorder.onstop = () => {
  const blob = new Blob(chunks, {type:"video/webm"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "stream.webm";
  a.click();
 };
 recorder.start();
};

// Camera / Screen buttons
document.getElementById("camBtn").onclick = setCam;
document.getElementById("screenBtn").onclick = setScreen;

// Create room
document.getElementById("createBtn").onclick = async () => {
 await initPeer();
 await setCam();
 roomRef = doc(collection(db,"rooms"));
 const roomId = roomRef.id;
 document.getElementById("roomInput").value = roomId;

 const offer = await pc.createOffer();
 await pc.setLocalDescription(offer);
 await setDoc(roomRef, {offer, viewers:1, password:document.getElementById("passInput").value});
 status.textContent = "Room: "+roomId;

 // Listeners
 onSnapshot(roomRef, async snap=>{
   const data = snap.data();
   viewers.textContent = data?.viewers || 1;
   if(data?.answer && !pc.currentRemoteDescription){
     await pc.setRemoteDescription(data.answer);
   }
 });

 onSnapshot(collection(roomRef,"candidates"), snap=>{
   snap.docChanges().forEach(c=>{
     if(c.type==="added") pc.addIceCandidate(c.doc.data());
   });
 });

 onSnapshot(collection(roomRef,"chat"), snap=>{
   snap.docChanges().forEach(c=>{
     chatDiv.innerHTML += c.doc.data().msg + "<br>";
   });
 });

 listRooms();
};

// Join room
document.getElementById("joinBtn").onclick = async () => {
 const roomId = document.getElementById("roomInput").value;
 roomRef = doc(db,"rooms",roomId);
 const roomData = (await getDoc(roomRef)).data();
 if(roomData.password !== document.getElementById("passInput").value){
   alert("Wrong password"); return;
 }

 await initPeer();
 await setCam();

 await pc.setRemoteDescription(roomData.offer);
 const answer = await pc.createAnswer();
 await pc.setLocalDescription(answer);
 await updateDoc(roomRef,{answer, viewers:(roomData.viewers||1)+1});

 onSnapshot(collection(roomRef,"candidates"), snap=>{
   snap.docChanges().forEach(c=>{
     if(c.type==="added") pc.addIceCandidate(c.doc.data());
   });
 });

 onSnapshot(collection(roomRef,"chat"), snap=>{
   snap.docChanges().forEach(c=>{
     chatDiv.innerHTML += c.doc.data().msg + "<br>";
   });
 });
};

// Chat
document.getElementById("chatInput").onkeydown = e => {
 if(e.key==="Enter" && roomRef){
   addDoc(collection(roomRef,"chat"), {msg:(document.getElementById("username").value||"Guest")+": "+e.target.value});
   e.target.value="";
 }
};

// Public room list
async function listRooms(){
 roomsDiv.innerHTML = "<b>Public Rooms</b><br>";
 const qs = await getDocs(collection(db,"rooms"));
 qs.forEach(d => roomsDiv.innerHTML += d.id+"<br>");
}
listRooms();

</script>
</body>
</html>
