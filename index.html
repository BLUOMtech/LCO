<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BLUOM Stream FIXED</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;background:#0b0f1a;color:white;text-align:center}
video{width:45%;margin:10px;background:black;border-radius:10px}
button,input{margin:5px;padding:10px;border-radius:6px;border:none}
button{background:#1e90ff;color:white}
</style>
</head>
<body>

<h2>BLUOM Stream (Fixed)</h2>

<input id="roomIdInput" placeholder="Room ID">
<button id="createBtn">Create Room</button>
<button id="joinBtn">Join Room</button>

<br>
<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc,
  collection, addDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyBDZmMalbyUmKiTl7CaN5a5Zn-qTIFVI0E",
 authDomain:"live-camera-online.firebaseapp.com",
 projectId:"live-camera-online",
 storageBucket:"live-camera-online.firebasestorage.app",
 messagingSenderId:"914071703053",
 appId:"1:914071703053:web:c2b59d8750ee04a58b0f44"
};

const app=initializeApp(firebaseConfig);
const db=getFirestore(app);

let pc, localStream, roomRef;

const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");

async function initPeer(){
 pc=new RTCPeerConnection({
   iceServers:[{urls:"stun:stun.l.google.com:19302"}]
 });

 pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];

 pc.onicecandidate=e=>{
   if(e.candidate){
     addDoc(collection(roomRef,"candidates"),e.candidate.toJSON());
   }
 };
}

async function startCam(){
 localStream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
 localVideo.srcObject=localStream;
 localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
}

createBtn.onclick=async()=>{
 await initPeer();
 await startCam();

 roomRef=doc(collection(db,"rooms"));
 document.getElementById("roomIdInput").value=roomRef.id;

 const offer=await pc.createOffer();
 await pc.setLocalDescription(offer);
 await setDoc(roomRef,{offer});

 onSnapshot(roomRef,async snap=>{
   const data=snap.data();
   if(data.answer && !pc.currentRemoteDescription){
     await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
   }
 });

 onSnapshot(collection(roomRef,"candidates"),snap=>{
   snap.docChanges().forEach(c=>{
     if(c.type==="added"){
       pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
     }
   });
 });
};

joinBtn.onclick=async()=>{
 const roomId=document.getElementById("roomIdInput").value;
 roomRef=doc(db,"rooms",roomId);

 await initPeer();
 await startCam();

 const roomData=(await getDoc(roomRef)).data();
 await pc.setRemoteDescription(new RTCSessionDescription(roomData.offer));

 const answer=await pc.createAnswer();
 await pc.setLocalDescription(answer);
 await updateDoc(roomRef,{answer});

 onSnapshot(collection(roomRef,"candidates"),snap=>{
   snap.docChanges().forEach(c=>{
     if(c.type==="added"){
       pc.addIceCandidate(new RTCIceCandidate(c.doc.data()));
     }
   });
 });
};
</script>

</body>
</html>
